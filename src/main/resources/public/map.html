<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Interactive Soil Map | Soil Health Monitor</title>
    <link rel="stylesheet" href="css/style.css"/>
    <link rel="stylesheet" href="css/map.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        .map-hero {
          background:
            linear-gradient(180deg, rgba(30,132,73,.7), rgba(30,132,73,.35)),
            url("images/images-5.jpg") center/cover no-repeat;
          color:#fff;padding:36px 0;margin-bottom:0
        }
        .map-hero h1{margin:0}
        .map-container{display:flex;min-height:calc(100vh - 220px)}
        #map{flex:1}
    </style>
</head>
<body>
<header>
    <div class="container header-container">
        <a class="logo-link" href="index.html">
            <svg class="logo-icon" viewBox="0 0 40 40" fill="none" aria-hidden="true">
                <rect width="40" height="40" rx="8" fill="#27ae60"/>
                <path d="M20 10C20 10 10 15 10 25C10 28 12 30 20 30C28 30 30 28 30 25C30 15 20 10 20 10Z" fill="white"/>
                <circle cx="20" cy="20" r="3" fill="#27ae60"/>
            </svg>
            <span class="logo-text">Soil Health Monitor</span>
        </a>
        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a class="active" href="map.html">Interactive Map</a></li>
                <li><a href="recommendations.html">Get Recommendations</a></li>
                <li><a href="dashboard.html">Dashboard</a></li>
            </ul>
        </nav>
        <a class="login-btn" href="#">Login</a>
    </div>
</header>

<section class="map-hero">
    <div class="container">
        <h1>See nutrient patterns. Act with precision.</h1>
        <p style="opacity:.95;max-width:840px">Live data when your API is up; clean fallback polygons when it isn’t. Hover districts to inspect N-P-K, click for tailored actions.</p>
    </div>
</section>

<main class="map-container">
    <aside class="map-sidebar">
        <div class="sidebar-header">
            <h3>Soil Health Map</h3>
            <p>Explore NPK levels across regions</p>
        </div>

        <div class="filter-section">
            <h4>Select Nutrient</h4>
            <div class="nutrient-selector">
                <button class="nutrient-btn active" data-nutrient="nitrogen"><span class="nutrient-icon">N</span>Nitrogen</button>
                <button class="nutrient-btn" data-nutrient="phosphorus"><span class="nutrient-icon">P</span>Phosphorus</button>
                <button class="nutrient-btn" data-nutrient="potassium"><span class="nutrient-icon">K</span>Potassium</button>
            </div>
        </div>

        <div class="filter-section">
            <h4>Filter by State</h4>
            <select id="stateFilter" class="filter-select">
                <option value="">All States</option>
                <option value="DL">Delhi</option>
                <option value="HR">Haryana</option>
                <option value="PB">Punjab</option>
                <option value="UP">Uttar Pradesh</option>
                <option value="MH">Maharashtra</option>
            </select>
        </div>

        <div class="legend-section">
            <h4 id="legendTitle">Nitrogen Legend</h4>
            <div class="legend-items">
                <div class="legend-item"><span class="legend-color high"></span><span id="legendHigh">High (&gt; 560 kg/ha)</span></div>
                <div class="legend-item"><span class="legend-color medium"></span><span id="legendMedium">Medium (280–560 kg/ha)</span></div>
                <div class="legend-item"><span class="legend-color low"></span><span id="legendLow">Low (&lt; 280 kg/ha)</span></div>
            </div>
        </div>

        <div class="info-section" id="districtInfo" style="display:none">
            <h4>District Information</h4>
            <div class="info-content">
                <div class="info-row"><span class="info-label">District:</span><span class="info-value" id="infoDistrictName">-</span></div>
                <div class="info-row"><span class="info-label">State:</span><span class="info-value" id="infoStateName">-</span></div>

                <div class="nutrient-levels">
                    <div class="nutrient-level"><span class="nutrient-badge n">N</span><div><div class="level-value" id="nitrogenValue">-</div><div class="level-status" id="nitrogenStatus">-</div></div></div>
                    <div class="nutrient-level"><span class="nutrient-badge p">P</span><div><div class="level-value" id="phosphorusValue">-</div><div class="level-status" id="phosphorusStatus">-</div></div></div>
                    <div class="nutrient-level"><span class="nutrient-badge k">K</span><div><div class="level-value" id="potassiumValue">-</div><div class="level-status" id="potassiumStatus">-</div></div></div>
                </div>

                <button class="btn-recommendations" onclick="location.href='recommendations.html'">Get Recommendations</button>
            </div>
        </div>
    </aside>

    <div id="map" class="map-view" aria-label="Soil health map of India"></div>
</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map', {zoomControl:true}).setView([23.5937, 78.9629], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 18, attribution:'© OpenStreetMap'}).addTo(map);

    const color = {high:'#2ecc71', medium:'#f1c40f', low:'#e74c3c', nodata:'#95a5a6'};
    const nutrientBtns = document.querySelectorAll('.nutrient-btn');
    let currentNutrient = 'nitrogen';
    let layer;

    function statusColor(s){ return (color[(s||'').toLowerCase()] || color.nodata); }
    function styleFor(f){
      const s = f.properties[currentNutrient + '_status'] || 'nodata';
      return { fillColor: statusColor(s), color:'#fff', weight:1, opacity:1, fillOpacity:.75 };
    }
    function updateInfo(p){
      document.getElementById('districtInfo').style.display='block';
      document.getElementById('infoDistrictName').textContent = p.district_name || '-';
      document.getElementById('infoStateName').textContent    = p.state_name || '-';
      ['nitrogen','phosphorus','potassium'].forEach(n=>{
        const v = p[n+'_avg']; const s = (p[n+'_status']||'-').toLowerCase();
        document.getElementById(n+'Value').textContent = v!=null ? v+' kg/ha' : 'No data';
        const el = document.getElementById(n+'Status');
        el.textContent = (s||'-'); el.className = 'level-status '+s;
      });
    }
    function setLegend(){
      const head = currentNutrient.charAt(0).toUpperCase()+currentNutrient.slice(1);
      document.getElementById('legendTitle').textContent = head+' Legend';
      const ranges = { nitrogen:['> 560','280–560','< 280'], phosphorus:['> 25','10–25','< 10'], potassium:['> 280','110–280','< 110'] }[currentNutrient];
      document.getElementById('legendHigh').textContent   = `High (${ranges[0]} kg/ha)`;
      document.getElementById('legendMedium').textContent = `Medium (${ranges[1]} kg/ha)`;
      document.getElementById('legendLow').textContent    = `Low (${ranges[2]} kg/ha)`;
    }

    // Minimal demo when API is down (simple boxes near Delhi, Pune, Lucknow)
    const demo = {"type":"FeatureCollection","features":[
      {"type":"Feature","properties":{"district_name":"Delhi (demo)","state_name":"Delhi","nitrogen_avg":110,"nitrogen_status":"Low","phosphorus_avg":18,"phosphorus_status":"Medium","potassium_avg":300,"potassium_status":"High"},"geometry":{"type":"Polygon","coordinates":[[[77.05,28.38],[77.40,28.38],[77.40,28.88],[77.05,28.88],[77.05,28.38]]]}},
      {"type":"Feature","properties":{"district_name":"Pune (demo)","state_name":"Maharashtra","nitrogen_avg":640,"nitrogen_status":"High","phosphorus_avg":28,"phosphorus_status":"High","potassium_avg":90,"potassium_status":"Low"},"geometry":{"type":"Polygon","coordinates":[[[73.6,18.3],[74.2,18.3],[74.2,18.9],[73.6,18.9],[73.6,18.3]]]}},
      {"type":"Feature","properties":{"district_name":"Lucknow (demo)","state_name":"Uttar Pradesh","nitrogen_avg":320,"nitrogen_status":"Medium","phosphorus_avg":12,"phosphorus_status":"Medium","potassium_avg":150,"potassium_status":"Medium"},"geometry":{"type":"Polygon","coordinates":[[[80.8,26.6],[81.3,26.6],[81.3,27.1],[80.8,27.1],[80.8,26.6]]]}}
    ]};

    async function loadData(){
      try {
        // Your Micronaut endpoint if present
        const res = await fetch('/api/map/districts', {headers:{Accept:'application/json'}});
        if(!res.ok) throw new Error('fallback');
        const geo = await res.json();
        return geo && geo.type==='FeatureCollection' ? geo : demo;
      } catch {
        return demo;
      }
    }

    function render(geo){
      if(layer) map.removeLayer(layer);
      layer = L.geoJSON(geo, {
        style: styleFor,
        onEachFeature: (f, l) => {
          l.on({
            mouseover: e => { e.target.setStyle({weight:3, color:'#333', fillOpacity:.9}); e.target.bringToFront(); updateInfo(f.properties); },
            mouseout:  e => { layer.resetStyle(e.target); }
          });
          l.bindTooltip(`${f.properties.district_name}`, {sticky:true});
        }
      }).addTo(map);
    }

    // nutrient toggles
    nutrientBtns.forEach(b => b.addEventListener('click', () => {
      nutrientBtns.forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      currentNutrient = b.dataset.nutrient;
      setLegend(); if(layer) layer.setStyle(styleFor);
    }));

    setLegend();
    loadData().then(render);
</script>
</body>
</html>
